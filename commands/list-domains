#!/bin/bash
SERVICE_NAME="$1"

if [ -z "$SERVICE_NAME" ]; then
    echo "Usage: gokku nginx:list-domains <service>"
    echo ""
    echo "Examples:"
    echo "  gokku nginx:list-domains nginx-lb"
    exit 1
fi

# Source plugin helpers
source /opt/gokku/scripts/plugin-helpers.sh

# Source local functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/functions.sh"

echo "Configured domains for service '$SERVICE_NAME':"
echo "=============================================="

load_metadata "$SERVICE_NAME"

# Get all domains from metadata
domains=$(echo "$METADATA" | jq -r ".domains | keys[]" 2>/dev/null)

if [ -z "$domains" ]; then
    echo "  No domains configured"
    exit 0
fi

domain_count=0
while IFS= read -r domain; do
    if [ -n "$domain" ]; then
        locations_count=$(echo "$METADATA" | jq ".domains[\"$domain\"].locations | length" 2>/dev/null)
        locations_count=${locations_count:-0}
        
        if [ "$locations_count" = "null" ] || [ -z "$locations_count" ]; then
            locations_count=0
        fi
        
        echo "  $domain (${locations_count} location(s))"
        domain_count=$((domain_count + 1))
    fi
done <<< "$domains"

echo ""
echo "Total: $domain_count domain(s)"
echo ""
