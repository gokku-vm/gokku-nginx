#!/bin/bash
SERVICE_NAME="$1"
APP_NAME="$2"
PROCESS_TYPE="$3"

if [ -z "$SERVICE_NAME" ] || [ -z "$APP_NAME" ]; then
    echo "Usage: gokku nginx:update-upstream <service> <app> [process-type]"
    echo ""
    echo "Examples:"
    echo "  gokku nginx:update-upstream nginx-lb api"
    echo "  gokku nginx:update-upstream nginx-lb api web"
    exit 1
fi

# Source plugin helpers from Gokku repository https://github.com/thadeu/gokku/blob/main/scripts/plugin-helpers.sh
source /opt/gokku/scripts/plugin-helpers.sh

# Source local functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/functions.sh"

echo "-----> Updating upstream for app '$APP_NAME'"

# Determine upstream name
if [ -n "$PROCESS_TYPE" ]; then
    UPSTREAM_NAME="${APP_NAME}-${PROCESS_TYPE}"
else
    UPSTREAM_NAME="$APP_NAME"
fi

# Wait for containers to be ready after app update
echo "-----> Waiting for containers to be ready..."
max_attempts=10
attempt=0
while [ $attempt -lt $max_attempts ]; do
    get_ports_by_name "$APP_NAME"
    if [ ${#PORTS[@]} -gt 0 ]; then
        echo "-----> Found ${#PORTS[@]} container(s) ready"
        break
    fi
    attempt=$((attempt + 1))
    if [ $attempt -lt $max_attempts ]; then
        sleep 1
    fi
done

# Get all running container ports using docker ps (final check)
get_ports_by_name "$APP_NAME"

# Debug: Show what containers were found
echo "-----> Debug: Searching for containers matching '$APP_NAME'"
docker ps --filter "status=running" --format "table {{.Names}}\t{{.Ports}}" | grep -E "NAME|${APP_NAME}" || echo "-----> No containers found with name pattern '$APP_NAME'"

# Update upstream configuration file
UPSTREAM_FILE="/opt/gokku/services/$SERVICE_NAME/conf.d/upstreams/${UPSTREAM_NAME}.conf"

if [ ${#PORTS[@]} -eq 0 ]; then
    echo "-----> WARNING: No running containers found for app '$APP_NAME'"
    echo "-----> Upstream will be created but may return 502/504 errors"
    # Use nginx_upstream_only which will create a placeholder upstream
    nginx_upstream_only "$UPSTREAM_FILE" "$UPSTREAM_NAME" "$SERVICE_NAME"
    echo "-----> Updated upstream configuration (no servers): $UPSTREAM_FILE"
else
    nginx_upstream_only "$UPSTREAM_FILE" "$UPSTREAM_NAME" "$SERVICE_NAME"
    echo "-----> Upstream configuration updated: $UPSTREAM_FILE"
    echo "-----> Added ${#PORTS[@]} server(s) to upstream '$UPSTREAM_NAME'"
    echo "-----> Ports: ${PORTS[*]}"
fi

# Regenerate all server blocks that use this upstream BEFORE reloading nginx
load_metadata "$SERVICE_NAME"
domains=$(echo "$METADATA" | jq -r ".domains | keys[]" 2>/dev/null)

if [ -n "$domains" ]; then
    # Use process substitution to avoid subshell issues
    while IFS= read -r domain; do
        if [ -n "$domain" ]; then
            uses_upstream=$(echo "$METADATA" | jq ".domains[\"$domain\"].locations[]? | select(.upstream == \"$UPSTREAM_NAME\")" 2>/dev/null)
            if [ -n "$uses_upstream" ] && [ "$uses_upstream" != "null" ]; then
                echo "-----> Regenerating server block for domain '$domain'"
                nginx_generate_server_block "$SERVICE_NAME" "$domain"
            fi
        fi
    done < <(echo "$domains")
    regenerate_default_server_block "$SERVICE_NAME"
fi

# Ensure container is running
if ! ensure_nginx_running "$SERVICE_NAME"; then
    echo "-----> Failed to start nginx container"
    exit 1
fi

# Test configuration before applying
echo "-----> Testing nginx configuration..."
if ! docker exec "$SERVICE_NAME" nginx -t; then
    echo "-----> Configuration test failed"
    echo "-----> Fix configuration errors before continuing"
    exit 1
fi

# Reload nginx configuration (prefer reload over restart)
echo "-----> Reloading nginx configuration"
if docker exec "$SERVICE_NAME" nginx -s reload 2>/dev/null; then
    echo "-----> Nginx configuration reloaded successfully"
else
    echo "-----> Reload failed, restarting container..."
    if docker restart "$SERVICE_NAME" >/dev/null 2>&1; then
        echo "-----> Waiting for nginx to restart..."
        wait_for_container "$SERVICE_NAME" 30
        
        if container_is_running "$SERVICE_NAME"; then
            echo "-----> Nginx container restarted successfully"
        else
            echo "-----> Warning: Container restarted but may not be running properly"
            docker logs --tail 20 "$SERVICE_NAME" 2>/dev/null || true
        fi
    else
        echo "-----> Failed to restart nginx container"
        exit 1
    fi
fi

echo "-----> Upstream '$UPSTREAM_NAME' updated"
