#!/bin/bash
SERVICE_NAME="$1"
APP_NAME="$2"
LOCATION_PATH="$3"
DOMAIN="$4"

if [ -z "$SERVICE_NAME" ] || [ -z "$APP_NAME" ] || [ -z "$LOCATION_PATH" ]; then
    echo "Usage: gokku nginx:remove-location <service> <app> <path> [domain]"
    echo ""
    echo "Examples:"
    echo "  gokku nginx:remove-location nginx-lb user-service /users"
    echo "  gokku nginx:remove-location nginx-lb order-service /orders api.example.com"
    exit 1
fi

# Source plugin helpers
source /opt/gokku/scripts/plugin-helpers.sh

# Source local functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/functions.sh"

# Get domain from CNAME if not provided
if [ -z "$DOMAIN" ]; then
    APP_DIR="/opt/gokku/apps/$APP_NAME"
    CNAME_FILE="$APP_DIR/CNAME"
    
    if [ -f "$CNAME_FILE" ]; then
        DOMAIN=$(cat "$CNAME_FILE" | tr -d '\n')
        echo "-----> Using domain from app CNAME: $DOMAIN"
    else
        echo "-----> Error: Domain not provided and no CNAME found for app '$APP_NAME'"
        echo "-----> Please provide domain explicitly: gokku nginx:remove-location $SERVICE_NAME $APP_NAME $LOCATION_PATH <domain>"
        exit 1
    fi
fi

# Normalize path
if [ "$LOCATION_PATH" != "/" ]; then
    if [[ ! "$LOCATION_PATH" =~ ^/ ]]; then
        LOCATION_PATH="/$LOCATION_PATH"
    fi
    if [[ ! "$LOCATION_PATH" =~ /$ ]]; then
        LOCATION_PATH="$LOCATION_PATH/"
    fi
fi

echo "-----> Removing location '$LOCATION_PATH' for app '$APP_NAME' from domain '$DOMAIN'"

# Check if location exists and validate app matches
load_metadata "$SERVICE_NAME"
location_exists=$(echo "$METADATA" | jq ".domains[\"$DOMAIN\"].locations[]? | select(.path == \"$LOCATION_PATH\")" 2>/dev/null)

if [ -z "$location_exists" ] || [ "$location_exists" = "null" ]; then
    echo "-----> Location '$LOCATION_PATH' not found for domain '$DOMAIN'"
    exit 1
fi

# Validate that the app matches
location_app=$(echo "$location_exists" | jq -r ".app" 2>/dev/null)
if [ "$location_app" != "$APP_NAME" ]; then
    echo "-----> Error: Location '$LOCATION_PATH' for domain '$DOMAIN' is associated with app '$location_app', not '$APP_NAME'"
    exit 1
fi

# Remove location from metadata
metadata_remove_location "$SERVICE_NAME" "$DOMAIN" "$LOCATION_PATH"

# Regenerate server block
nginx_generate_server_block "$SERVICE_NAME" "$DOMAIN"

# Regenerate default server block to ensure IP blocking is active
regenerate_default_server_block "$SERVICE_NAME"

echo "-----> Location '$LOCATION_PATH' removed from domain '$DOMAIN'"

# Ensure container is running
if ! ensure_nginx_running "$SERVICE_NAME"; then
    echo "-----> Failed to start nginx container"
    exit 1
fi

# Test configuration before applying
echo "-----> Testing nginx configuration..."
if ! docker exec "$SERVICE_NAME" nginx -t; then
    echo "-----> Configuration test failed"
    echo "-----> Fix configuration errors before continuing"
    exit 1
fi

# Reload nginx configuration
echo "-----> Reloading nginx configuration"

docker restart "$SERVICE_NAME" >/dev/null 2>&1
wait_for_container "$SERVICE_NAME" 30

if container_is_running "$SERVICE_NAME"; then
    echo "-----> Nginx container restarted"
else
    echo "-----> Warning: Container may not be running properly"
fi

echo "-----> Location '$LOCATION_PATH' successfully removed"

